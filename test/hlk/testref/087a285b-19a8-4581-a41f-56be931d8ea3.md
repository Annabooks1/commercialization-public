---
title: Registry Callback Tests
Description: Registry Callback Tests
ms.assetid: 343ecedd-d196-47a1-bd4d-a02b68a35f6f
author: sapaetsc-msft
ms.author: sapaetsc
ms.date: 08/28/17
ms.topic: article
ms.prod: windows-hardware
ms.technology: windows-oem
---

# Registry Callback Tests

<conditional_block> <conditions> <docset value="standalone"></docset> </conditions>

>[!NOTE]
You can find the latest version of this test documentation on MSDN at the following link:

-   <xref hlink="http://msdn.microsoft.com/en-us/library/windows/hardware/343ecedd-d196-47a1-bd4d-a02b68a35f6f">http://msdn.microsoft.com/en-us/library/windows/hardware/343ecedd-d196-47a1-bd4d-a02b68a35f6f</b>


</conditional_block>

This automated test exercises basic test cases for a registry filter driver.

## Test details

<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<tbody>
<tr class="odd">
<td><mark type="bullet_intro">Specifications</b></td>
<td><ul>
<li>Filter.Driver.FileSystem.MiniFilter</li>
<li>Filter.Driver.FileSystem.RegistryAndProcess</li>
<li>Filter.Driver.AntiVirus.RegistryAndProcess</li>
<li>Filter.Driver.AntiVirus.MiniFilter</li>
</ul></td>
</tr>
<tr class="even">
<td><mark type="bullet_intro">Platforms</b></td>
<td><ul>
<li><tla rid="win_threshold_desktop"></tla> x86</li>
<li><tla rid="win_threshold_desktop"></tla> x64</li>
<li><tla rid="win_threshold_server"></tla> x64</li>
</ul></td>
</tr>
<tr class="odd">
<td><mark type="bullet_intro">Supported Releases</b></td>
<td><ul>
<li><tla rid="win_10"></tla></li>
<li><tla rid="win_10_th2"></tla></li>
<li><tla rid="win_10_rs1"></tla></li>
<li>Windows 10, version 1703</li>
<li>Windows 10, version 1709</li>
</ul></td>
</tr>
<tr class="even">
<td><mark type="bullet_intro">Expected run time (in minutes)</b></td>
<td>30</td>
</tr>
<tr class="odd">
<td><mark type="bullet_intro">Category</b></td>
<td>Development</td>
</tr>
<tr class="even">
<td><mark type="bullet_intro">Timeout (in minutes)</b></td>
<td>30</td>
</tr>
<tr class="odd">
<td><mark type="bullet_intro">Requires reboot</b></td>
<td>false</td>
</tr>
<tr class="even">
<td><mark type="bullet_intro">Requires special configuration</b></td>
<td>false</td>
</tr>
<tr class="odd">
<td><mark type="bullet_intro">Type</b></td>
<td>automatic</td>
</tr>
</tbody>
</table>

## Additional documentation

Tests in this feature area might have additional documentation, including prerequisites, setup, and troubleshooting information, that can be found in the following topic(s):

-   <xref rid="p_hlk_test.filter_driver_additional_documentation">Filter.Driver additional documentation</b>

## Running the test

Before you run the test, complete the test setup as described in the test requirements: <xref rid="p_hlk_test.file_system_testing_prerequisites">File System Testing Prerequisites</b>.

## Troubleshooting

For generic troubleshooting of HLK test failures, see <xref rid="p_hlk.troubleshooting_windows_hlk_test_failures">Troubleshooting Windows HLK Test Failures</b>.

For troubleshooting information, see <xref rid="p_hlk_test.troubleshooting_file_system_testing">Troubleshooting File System Testing</b>.

All test cases return Pass or Fail. To review test details, review the test log from Windows Hardware Lab Kit (Windows HLK) Studio. For test failures, search for the term “+sev” in the log.

## More information

This test includes the following test cases:

-   Altitude Conflict

-   CreateKey Block

-   CreateKey Bypass

-   CreateKey Override Access Denied

-   CreateKey Override Block

-   SetKeySecurity Bypass

-   Transacted CreateKey Bypass

-   Transacted CreateKey Bypass (No Commit)

-   Unregister Close Race

-   Save Restore Replace

To manually run each test case, use the following procedures.

**To manually run the Altitude Conflict test case**

1.  Register a callback at altitude 1000.

2.  Register another callback at the same altitude, and then verify that it fails.

3.  CreateKey the Monitor test.

4.  Register three of the same callbacks at altitudes 1000, 2000, and 3000. Set all three callbacks to “monitor” mode. This means that the callback will do nothing but return STATUS\_SUCCESS.

5.  Create a key, and then verify that it succeeds.

6.  Unregister the callbacks.

7.  Verify that each callback was invoked appropriately based on its altitude.

**To manually run the CreateKey Block test case**

1.  Register three of the same callbacks at altitudes 1000, 2000, and 3000.

2.  Set callbacks 1000 and 3000 to “monitor” mode. This means that the callback will do nothing but return STATUS\_SUCCESS.

3.  Set callback 2000 to “block” mode. This means that the callback will return an error status.

4.  Create a key, and then verify that it fails.

5.  Unregister the callbacks.

6.  Verify that each callback was invoked appropriately based on its altitude.

**To manually run the CreateKey Bypass test case**

1.  Register three of the same callbacks at altitudes 1000, 2000, and 3000.

2.  Set callbacks 1000 and 3000 to “monitor” mode. This means that the callback will do nothing but return STATUS\_SUCCESS.

3.  Set callback 2000 to “bypass” mode. This means that the callback will return an STATUS\_CALLBACK\_BYPASS and perform the operation on behalf of the registry.

4.  Create a key, and then verify that it succeeds.

5.  Unregister the callbacks.

6.  Verify that each callback was invoked appropriately based on its altitude.

**To manually run the CreateKey Override Access Denied test case**

1.  Create a key K1, and then set its discretionary access control list (DACL) to give read-only access.

2.  Create a key under K1. This should fail because of the read-only DACL.

3.  Register three of the same callbacks at altitudes 1000, 2000, and 3000. STATUS\_CALLBACK\_BYPASS.

4.  Set callbacks 1000 and 3000 to “monitor” mode. This means that the callback will do nothing but return STATUS\_SUCCESS.

5.  Set callback 2000 to “access denied bypass” mode. This means that the callback will perform the operation from user mode, not be blocked by the read-only DACL, and return.

6.  Create a key under K1, and then verify that it succeeds.

7.  Unregister the callbacks.

8.  Verify that each callback was invoked appropriately based on its altitude.

**To manually run the CreateKey Override Block test case**

1.  Register four of the same callbacks at altitudes 1000, 2000, 3000, and 4000.

2.  Set callbacks 1000 and 4000 to “monitor” mode. This means that the callback will do nothing but return STATUS\_SUCCESS.

3.  Set callback 2000 to “block” mode. This means that the callback will return STATUS\_UNSUCCESSFUL.

4.  Set callback 3000 to “override failure” mode. This means that if the callback identifies STATUS\_UNSUCCESSFUL in the post-operation callback, it will still perform the operation and return success.

5.  Create a key, and then verify that it succeeds.

6.  Unregister the callbacks.

7.  Verify that each callback was invoked appropriately based on its altitude.

**To manually run the SetKeySecurity Bypass test case**

1.  Register three of the same callbacks at altitudes 1000, 2000, and 3000.

2.  Set callbacks 1000 and 3000 to “monitor” mode. This means that the callback will do nothing but return STATUS\_SUCCESS.

3.  Set callback 2000 to “bypass” mode. This means that the callback will return STATUS\_CALLBACK\_BYPASS and perform the operation on behalf of the registry.

4.  Call **RegSetKeySecurity** to set the security descriptor of a key, and then verify that it succeeds.

5.  Unregister the callbacks.

6.  Verify that each callback was invoked appropriately based on its altitude.

**To manually run the Transacted CreateKey Bypass test case**

1.  Create a transaction T1.

2.  Create a key in the context of transaction T1.

3.  Verify that the key succeeds, and then delete it.

4.  Register three of the same callbacks at altitudes 1000, 2000, and 3000.

5.  Set callbacks 1000 and 3000 to “monitor” mode. This means that the callback will do nothing but return STATUS\_SUCCESS.

6.  Set callback 2000 to “bypass” mode. This means that the callback will return STATUS\_CALLBACK\_BYPASS and perform the operation on behalf of the registry.

7.  Create a key in the context of transaction T1, and then verify that it succeeds.

8.  Commit the transaction.

9.  Unregister the callbacks.

**To manually run the Transacted CreateKey Bypass (No Commit) test case**

-   Complete the same steps as in the Transacted CreateKey Bypass test case, but do not commit the transaction at the end.

**To manually run the Unregister Close Race test case**

1.  Start a thread that opens a test key, and then close the handle in a loop.

2.  In the original thread, register and unregister a callback 100 times.

3.  Signal the other thread to exit.

**To manually run the Save Restore Replace test case**

1.  Create a key under the software hive.

2.  Register a callback at altitude 1000 and set it to “monitor” mode. This means that the callback will do nothing but return STATUS\_SUCCESS.

3.  Call **RegSaveKey** on the created key, and then verify that it succeeds.

4.  Call **RegRestoreKey** on the created key by using the hive file that **RegSaveKey** created, and then verify that it succeeds.

5.  Make a copy of the hive file.

6.  Load the original hive file under HKEY\_LOCAL\_MACHINE, and then verify that it succeeds.

7.  Call **RegReplaceKey** by using the copy of the hive file. This should fail with a sharing violation, but it will still trigger the callbacks for this operation.

8.  Unregister the callback, and then verify that it was invoked appropriately.

## Command syntax

<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead>
<tr class="header">
<th>Command option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><strong>RegCbTestctrl.exe -regr</strong></p></td>
<td><p>Runs the test.</p></td>
</tr>
</tbody>
</table>

>[!NOTE]
For command-line help for this test binary, type **/h**.


## File list

<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead>
<tr class="header">
<th>File</th>
<th>Location</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>RegCbTestCtrl.exe</p></td>
<td><p>[WTT\TestBinRoot]\NTTEST\BASETEST\kernel\cm</p></td>
</tr>
<tr class="even">
<td><p>RegCbTest.sys</p></td>
<td><p>[WTT\TestBinRoot]\NTTEST\BASETEST\kernel\cm</p></td>
</tr>
<tr class="odd">
<td><p>Ntlog.dll</p></td>
<td><p></p></td>
</tr>
</tbody>
</table>

## Parameters

| Parameter name                                   | Parameter description |
|--------------------------------------------------|-----------------------|
| <mark type="bullet_intro">LLU\_LclAdminUser</b>  | LLU for Execute       |
| <mark type="bullet_intro">LLU\_NetAccessOnly</b> | LLU for copy          |





