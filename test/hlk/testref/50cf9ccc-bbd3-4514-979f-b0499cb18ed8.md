---
title: SPI WinRT Clock Frequency Verification Tests (mbed LPC1768 Required)
Description: SPI WinRT Clock Frequency Verification Tests (mbed LPC1768 Required)
ms.assetid: 86daa706-3fe3-40b0-beb6-f0d73a76f501
author: sapaetsc-msft
ms.author: sapaetsc
ms.date: 08/28/17
ms.topic: article
ms.prod: windows-hardware
ms.technology: windows-oem
---

# SPI WinRT Clock Frequency Verification Tests (mbed LPC1768 Required)

<conditional_block> <conditions> <docset value="standalone"></docset> </conditions>

>[!NOTE]
You can find the latest version of this test documentation on MSDN at the following link:

-   <xref hlink="http://msdn.microsoft.com/en-us/library/windows/hardware/86daa706-3fe3-40b0-beb6-f0d73a76f501">http://msdn.microsoft.com/en-us/library/windows/hardware/86daa706-3fe3-40b0-beb6-f0d73a76f501</b>


</conditional_block>

The SPI tests do functional and stress testing of SPI controllers exposed to usermode through the Windows.Devices.Spi WinRT APIs. The scope of testing includes:

-   Verification that an SPI controller with specified friendly name is accessible from usermode.
-   Verification that data is sent and received correctly over a range of SPI modes, clock frequencies, data bit lengths, and transfer lengths.
-   Verification there are no gaps between bytes within a transfer. Some devices such as LED strips and analog to digital converters require an uninterrupted clock signal.
-   Verification that the actual clock speed used is within 15% of the requested value.
-   Verification that when a transfer is attempted with a buffer length that is not a multiple of the stride, the transfer is failed with STATUS\_INVALID\_PARAMETER and no activity is generated on the bus. The stride is determined by DataBitLength as follows:
    |               |        |
    |---------------|--------|
    | DataBitLength | Stride |
    | 4 - 8         | 1      |
    | 9 - 16        | 2      |
    | 17 - 32       | 4      |

Tests run against an externally connected <xref hlink="https://developer.mbed.org/platforms/mbed-LPC1768/"> mbed LPC1768</b>. The mbed LPC1768 is a popular microcontroller prototyping platform that can be purchased from a variety of online retailers including <xref hlink="https://www.sparkfun.com/products/9564">Sparkfun</b>, <xref hlink="http://www.digikey.com/product-detail/en/OM11043/568-4916-ND/2138502">Digikey</b>, and <xref hlink="http://www.adafruit.com/products/834">Adafruit</b>. Programming the mbed with the test firmware image is as simple as dragging and dropping the firmware image to the mass storage device. The firmware source code is available on <xref hlink="https://github.com/ms-iot/busses-tester">github</b>. Detailed instructions on preparing the mbed and running the tests are provided below.

## Test details

<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<tbody>
<tr class="odd">
<td><mark type="bullet_intro">Specifications</b></td>
<td><ul>
<li>Device.BusController.SPI.WinRT.Discretional</li>
</ul></td>
</tr>
<tr class="even">
<td><mark type="bullet_intro">Platforms</b></td>
<td><ul>
</ul></td>
</tr>
<tr class="odd">
<td><mark type="bullet_intro">Supported Releases</b></td>
<td><ul>
<li><tla rid="win_10"></tla></li>
<li><tla rid="win_10_th2"></tla></li>
<li><tla rid="win_10_rs1"></tla></li>
<li>Windows 10, version 1703</li>
<li>Windows 10, version 1709</li>
</ul></td>
</tr>
<tr class="even">
<td><mark type="bullet_intro">Expected run time (in minutes)</b></td>
<td>15</td>
</tr>
<tr class="odd">
<td><mark type="bullet_intro">Category</b></td>
<td>Development</td>
</tr>
<tr class="even">
<td><mark type="bullet_intro">Timeout (in minutes)</b></td>
<td>30</td>
</tr>
<tr class="odd">
<td><mark type="bullet_intro">Requires reboot</b></td>
<td>false</td>
</tr>
<tr class="even">
<td><mark type="bullet_intro">Requires special configuration</b></td>
<td>true</td>
</tr>
<tr class="odd">
<td><mark type="bullet_intro">Type</b></td>
<td>automatic</td>
</tr>
</tbody>
</table>

## Additional documentation

Tests in this feature area might have additional documentation, including prerequisites, setup, and troubleshooting information, that can be found in the following topic(s):

-   <xref rid="p_hlk_test.device_buscontroller_additional_documentation">Device.BusController additional documentation</b>

## Running the test

You will need the following hardware to run the tests:

-   <xref hlink="https://developer.mbed.org/platforms/mbed-LPC1768/">mbed LPC1768</b>
-   Breadboard
-   Jumper Wires

First, you must load the test firmware onto the mbed:

1.  Plug in the mbed LPC1768 over USB to your PC. It will show up as a removable drive on your PC.
2.  Open the drive in file explorer
3.  Copy c:\\Program Files (x86)\\Windows Kits\\10\\Hardware Lab Kit\\Tests\\x86\\iot\\busses-tester-mbed\_LPC1768.bin to the drive
4.  Press the button on the mbed to reset the microcontroller

Next, wire up the mbed to your SPI controller under test. To power the mbed, you can plug it in over USB to your device under test or connect the VIN and GND pins directly to power pins on your device under test. Make the following connections between your device under test and the mbed: (<xref hlink="https://developer.mbed.org/platforms/mbed-LPC1768">mbed pinout</b>),

1.  Connect mbed pin 13 (P0.15/SCK0) to the SCK pin on your device under test
2.  Connect mbed pin 30 (P0.4/CAP2.0) to the SCK pin on your device under test (this pin is used for precise clock measurement)
3.  Connect mbed pin 11 (P0.18/MOSI0) to the MOSI pin on your device under test
4.  Connect mbed pin 12 (P0.17/MISO0) to the MISO pin on your device under test
5.  Connect mbed pin 14 (P0.16/SSEL0) to the Chip Select pin on your device under test
6.  Connect mbed GND to a GND pin on your device under test

You can now schedule the tests in HLK studio.

## Troubleshooting

For generic troubleshooting of HLK test failures, see <xref rid="p_hlk.troubleshooting_windows_hlk_test_failures">Troubleshooting Windows HLK Test Failures</b>.

We recommend running the tests on the command line to gain insight into failures and to quickly iterate on solutions. We also recommend hooking up a logic analyzer such as a <xref hlink="https://www.saleae.com/">salae</b>. It can be difficult or impossible to determine the cause of a failure without the ability to inspect bus traffic.

Here's how to run the tests on the command line:

1.  Copy %programfiles(x86)%\\Windows Kits\\10\\Testing\\Runtimes\\TAEF\\&lt;arch&gt;\\MinTe to c:\\data\\minte
2.  Copy Windows.Devices.LowLevel.UnitTests.dll from %programfiles(x86)%\\Windows Kits\\10\\Hardware Lab Kit\\Tests\\&lt;arch&gt;\\iot to c:\\data on your device.
3.  Telnet or ssh into your device
4.  Change directories to c:\\data
5.  Run the tests: `minte\te windows.devices.lowlevel.unittests.dll /name:SpiHlk*`

Command line test usage:

`minte\te windows.devices.lowlevel.unittests.dll [/name:test_name] [/p:SpiFriendlyName=friendly_name] [/p:ClockFrequency=clock_frequency] [/p:DataBitLength=data_bit_length] [/p:SpiMode=0|1|2|3] [/p:Length=length] [/p:WriteLength=write_length] [/p:ReadLength=read_length] [/p:ExtraClocks=extra_clocks] [/p:Verbose=true]`

-   test\_name - the name of the test to run which may include wildcards. Examples: /name:SpiHlk\*, /name:SpiHlkTests::VerifyClockFrequency\#metadataSet0
-   friendly\_name - the friendly name of the SPI controller under test. If omitted, the first enumerated controller is used. Examples: /p:SpiFriendlyName=SPI1
-   clock\_frequency - force a test to use the specified clock frequency. By default, the clock frequency comes from the test data, which is designed to give coverage over a range of frequencies. This parameter should be omitted under normal circumstances. Example: /p:ClockFrequency=1500000
-   data\_bit\_length - force a test to use the specified data bit length. Example: /p:DataBitLength=9
-   SpiMode - force a test to use the specified SPI mode. Example: /p:SpiMode=2
-   length - force a test to use the specified buffer length for the transfer. Example: /p:length=128
-   write\_length - force a TransferSequential test to use the specified buffer length for the write portion of the transfer. Example: /p:WriteLength=8
-   read\_length - force a TransferSequential test to use the specified buffer length for the read portion of the transfer. Example: /p:ReadLength=16
-   extra\_clocks - specify an adjustment to the number of clocks per byte that the tests use when computing expected clock active times for performance measurements, gap detection, and clock frequency validation. For example, the BCM2836 SPI controller waits an extra clock cycle after each byte, so to compensate for this behavior the measurements must be adjusted. Example: /p:ExtraClocks=1.5
-   /p:Verbose=true - turn on verbose output. This will cause entire buffers to be dumped to the console when a failure occurs. By default, only the first mismatched byte is displayed.

**Examples:**

List available tests:

`minte\te windows.devices.lowlevel.unittests.dll /list`

Run the IO validation tests:

`minte\te windows.devices.lowlevel.unittests.dll /name:SpiHlkIoTests*`

Run the gap detection tests:

`minte\te windows.devices.lowlevel.unittests.dll /name:SpiHlkGapTests*`

Run the clock frequency validation and stride tests:

`minte\te windows.devices.lowlevel.unittests.dll /name:SpiHlkTests*`

Run a specific test against a specific SPI controller instance:

`minte\te windows.devices.lowlevel.unittests.dll /name:SpiHlkIoTests#2::VerifyTransferSequential#metadataSet9 /p:SpiFriendlyName=SPI1`

A tool that can help with manual troubleshooting is <xref hlink="http://ms-iot.github.io/content/en-US/win10/samples/SpiTestTool.htm"> SpiTestTool</b>. SpiTestTool is a simple utility for interacting with SPI from the command line.

## More information

## Parameters

| Parameter name                                | Parameter description                                           |
|-----------------------------------------------|-----------------------------------------------------------------|
| <mark type="bullet_intro">SpiFriendlyName</b> | The friendly name of the SPI controller under test (e.g. SPI0). |





