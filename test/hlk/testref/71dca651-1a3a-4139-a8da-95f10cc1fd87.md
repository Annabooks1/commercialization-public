---
title: UEFI Tpr Test
Description: UEFI Tpr Test
ms.assetid: 2e6dfab6-f31d-4a15-b61a-466238af858b
author: sapaetsc-msft
ms.author: sapaetsc
ms.date: 08/28/17
ms.topic: article
ms.prod: windows-hardware
ms.technology: windows-oem
---

# UEFI Tpr Test

<conditional_block> <conditions> <docset value="standalone"></docset> </conditions>

>[!NOTE]
You can find the latest version of this test documentation on MSDN at the following link:

-   <xref hlink="http://msdn.microsoft.com/en-us/library/windows/hardware/2e6dfab6-f31d-4a15-b61a-466238af858b">http://msdn.microsoft.com/en-us/library/windows/hardware/2e6dfab6-f31d-4a15-b61a-466238af858b</b>


</conditional_block>

This test validates the UEFI implementation of the TPR command. eDrives unlocked by the operating system will remain unlocked on system crashes causing a security vulnerability for all such drives as the operating system cannot lock the drive on the crash. UEFI systems must issue a TPR command to each eDrive on the system to ensure that the drive is locked before booting into an operating system.

For example, this test creates a band on all eDrives and sets the state of that band to temporarily unlocked before invoking a system crash. Upon restart, the test runs again and checks the state of the band to ensure that it is locked.

## Test details

<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<tbody>
<tr class="odd">
<td><mark type="bullet_intro">Specifications</b></td>
<td><ul>
<li>System.Fundamentals.Firmware.TPR.UEFIEncryptedHDD</li>
</ul></td>
</tr>
<tr class="even">
<td><mark type="bullet_intro">Platforms</b></td>
<td><ul>
<li><tla rid="win_threshold_desktop"></tla> x86</li>
<li><tla rid="win_threshold_desktop"></tla> x64</li>
<li><tla rid="win_threshold_server"></tla> x64</li>
</ul></td>
</tr>
<tr class="odd">
<td><mark type="bullet_intro">Supported Releases</b></td>
<td><ul>
<li><tla rid="win_10"></tla></li>
<li><tla rid="win_10_th2"></tla></li>
<li><tla rid="win_10_rs1"></tla></li>
<li>Windows 10, version 1703</li>
<li>Windows 10, version 1709</li>
</ul></td>
</tr>
<tr class="even">
<td><mark type="bullet_intro">Expected run time (in minutes)</b></td>
<td>20</td>
</tr>
<tr class="odd">
<td><mark type="bullet_intro">Category</b></td>
<td>Compatibility</td>
</tr>
<tr class="even">
<td><mark type="bullet_intro">Timeout (in minutes)</b></td>
<td>20</td>
</tr>
<tr class="odd">
<td><mark type="bullet_intro">Requires reboot</b></td>
<td>false</td>
</tr>
<tr class="even">
<td><mark type="bullet_intro">Requires special configuration</b></td>
<td>false</td>
</tr>
<tr class="odd">
<td><mark type="bullet_intro">Type</b></td>
<td>automatic</td>
</tr>
</tbody>
</table>

## Additional documentation

Tests in this feature area might have additional documentation, including prerequisites, setup, and troubleshooting information, that can be found in the following topic(s):

-   <xref rid="p_hlk_test.system_fundamentals_additional_documentation">System.Fundamentals additional documentation</b>

## Running the test

Before you run the test, complete the test setup as described in the test requirements: <xref rid="p_hlk_test.wdtf_system_fundamentals_testing_prerequisites">WDTF System Fundamentals Testing Prerequisites</b>.

This test is a system test and as such runs against all systems and not specific drives in the device testing. All systems with UEFI and an eDrive attached will see this test in list of tests to run. A UEFI system with more than one eDrive will be checked for compliance.

The test will configure the system before causing a manually initiated bug check and finally validating the state of the drive after the system has rebooted. This means that seeing a manually initiated stop error is expected.

## Troubleshooting

For generic troubleshooting of HLK test failures, see <xref rid="p_hlk.troubleshooting_windows_hlk_test_failures">Troubleshooting Windows HLK Test Failures</b>.

For additional troubleshooting information, see <xref rid="p_hlk_test.troubleshooting_system_fundamentals_testing">Troubleshooting System Fundamentals Testing</b>.

The test needs to create a new band on the eDrive for testing, which requires that there is free space available to create the partition and band. If the eDrive already has volumes on it, the test will attempt to shrink a volume and use the free space to do the testing. If an error is encountered when trying to prepare the drive before the manually initiated crash, the following steps can be taken:

-   This error may be seen in the test logs as a VDS failure.

-   Manually remove all volumes from data drives by performing **diskpart clean** on the disk.

-   If the disk contains the boot volume, shrink volumes to create at least 100 MB of free space on boot volumes before running the test. This can be accomplished by using Disk Management.

## More information

The test is a system test and does all of its own device enumeration. The job first installs the bugcheck driver which allows the user-mode test application to force a system crash. During phase 1 of the test, the system is checked to ensure it is a UEFI system and has at least one eDrive connected. If the system does not meet these criteria the test is skipped and appears as a pass in the HLK studio and manager. For each eDrive enumerated on the system, a new 100MB band is created. If the drive already contains partitions such that there is not 100MB of free space, VDS is invoked to shrink the largest partition to create room for a new band. This means that the partitions on the drive must have been created in Windows and are not managed by a 3rd party TCG solution. Each of the new bands is set to the Temporary Unlock state before invoking the crashdump driver to cause a manually initiated system crash. When the system reboots the second part of the test runs to check that each of the bands is locked. Any unlocked bands cause the test to fail. The test bands are removed and the partitions extended if they were previously shrunk. Finally, the crashdump driver is removed from the system.

## Command usage

<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead>
<tr class="header">
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><strong>UefiTprTest.exe phase1</strong></p></td>
<td><p>Run phase 1 of the test to prepare the drives before crashing the system.</p></td>
</tr>
<tr class="even">
<td><p><strong>UefiTprTest.exe phase2</strong></p></td>
<td><p>Run phase 2 of the test to check the state of the drives after the reboot.</p></td>
</tr>
</tbody>
</table>

## Command syntax

<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead>
<tr class="header">
<th>Command option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>UefiTprTest.exe</p></td>
<td><p>The command-line options for the test are listed below.</p></td>
</tr>
<tr class="even">
<td><p>Phase1</p></td>
<td><p>Phase 1 prepares the drives for testing. This is needed to get the drives in the state they are needed before crashing the system.</p></td>
</tr>
<tr class="odd">
<td><p>Phase2</p></td>
<td><p>Phase 2 does the validation of the drives and their state after crashing the system.</p></td>
</tr>
</tbody>
</table>

>[!NOTE]
For command line help for this test binary, type **/?**.


## File list

<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<tbody>
<tr class="odd">
<td><p>File</p></td>
<td><p>Location</p></td>
</tr>
<tr class="even">
<td><p>bugcheck.sys</p></td>
<td><p><placeholder>&lt;[testbinroot]&gt;</placeholder>\nttest\driverstest\storage\wdk\</p></td>
</tr>
<tr class="odd">
<td><p>common.js</p></td>
<td><p><placeholder>&lt;[testbinroot]&gt;</placeholder>\NTTEST\driverstest\storage\crashdump\scripts\</p></td>
</tr>
<tr class="even">
<td><p>Crash.wsf</p></td>
<td><p><placeholder>&lt;[testbinroot]&gt;</placeholder>\NTTEST\driverstest\storage\crashdump\scripts\</p></td>
</tr>
<tr class="odd">
<td><p>bugcheckdrvctrl.dll</p></td>
<td><p><placeholder>&lt;[testbinroot]&gt;</placeholder>\nttest\driverstest\storage\wdk\crashtest\</p></td>
</tr>
<tr class="even">
<td><p>bugcheckdrvctrl.tlb</p></td>
<td><p><placeholder>&lt;[testbinroot]&gt;</placeholder>\nttest\driverstest\storage\wdk\crashtest\</p></td>
</tr>
<tr class="odd">
<td><p>UefiTprTest.exe</p></td>
<td><p><placeholder>&lt;[testbinroot]&gt;</placeholder>\nttest\driverstest\storage\wdk\</p></td>
</tr>
</tbody>
</table>

## Parameters

| Parameter name                                   | Parameter description                      |
|--------------------------------------------------|--------------------------------------------|
| <mark type="bullet_intro">LLU\_LclAdminUsr</b>   | User account for running the test.         |
| <mark type="bullet_intro">LLU\_NetAccessOnly</b> | User account for accessing test fileshare. |
| <mark type="bullet_intro">StorageDriveLetter</b> | Assigned by Create Storage Parameters.     |
| <mark type="bullet_intro">StorageDriveNumber</b> | Assigned by Create Storage Parameters.     |
| <mark type="bullet_intro">DiskDeviceObjLink</b>  | Assigned by Create Storage Parameters.     |





